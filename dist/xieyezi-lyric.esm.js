const t=/\[(\d{2,}):(\d{2})(?:\.(\d{2,3}))?]/g,i=0,s=1,e={title:"ti",artist:"ar",album:"al",offset:"offset",by:"by"};export default class{constructor(t,s=function(){}){this.lrc=t,this.tags={},this.lines=[],this.handler=s,this.state=i,this.curLine=0,this._init()}_init(){this._initTag(),this._initLines()}_initTag(){for(let t in e){const i=this.lrc.match(new RegExp(`\\[${e[t]}:([^\\]]*)]`,"i"));this.tags[t]=i&&i[1]||""}}_initLines(){const i=this.lrc.split("\n");for(let s=0;s<i.length;s++){const e=i[s];let h=t.exec(e);if(h){const i=e.replace(t,"").trim();console.log(i),i&&(3===h[3].length&&(h[3]=h[3]/10),this.lines.push({time:60*h[1]*1e3+1e3*h[2]+10*(h[3]||0),txt:i}))}}this.lines.sort((t,i)=>t.time-i.time)}_findCurNum(t){for(let i=0;i<this.lines.length;i++)if(t<=this.lines[i].time)return i;return this.lines.length-1}_callHandler(t){t<0||this.handler({txt:this.lines[t].txt,lineNum:t})}_playRest(){let t=this.lines[this.curNum].time-(+new Date-this.startStamp);this.timer=setTimeout(()=>{this._callHandler(this.curNum++),this.curNum<this.lines.length&&this.state===s&&this._playRest()},t)}play(t=0,i){this.lines.length&&(this.state=s,this.curNum=this._findCurNum(t),this.startStamp=+new Date-t,i||this._callHandler(this.curNum-1),this.curNum<this.lines.length&&(clearTimeout(this.timer),this._playRest()))}togglePlay(){var t=+new Date;this.state===s?(this.stop(),this.pauseStamp=t):(this.state=s,this.play((this.pauseStamp||t)-(this.startStamp||t),!0),this.pauseStamp=0)}stop(){this.state=i,clearTimeout(this.timer)}seek(t){this.play(t)}}
